#!/usr/bin/env bash

set -e

USAGE="
ROOTDIR=<rootdir> $(basename $0): <input_dir> <output_dir>
"

function _err(){
  echo "$@"
  exit 1
}

function main() {
  [ -z "$ROOT_DIR" ] && _err "ROOT_DIR env variable must be set"
  [ -z "$1" ] && _err "input_dir must be set"
  [ -z "$2" ] && err "output_dir must be set"

  INPUT_DIR=$1
  OUTPUT_DIR=$2

  rm -rf "$ROOT_DIR/$OUTPUT_DIR"/*.py
  echo "# generated by generate-protocol-files" > "$ROOT_DIR/$OUTPUT_DIR"/__init__.py

  for f in "$ROOT_DIR/$INPUT_DIR"/*.yaml; do
    filename_wo_ext=$(basename "$f" | cut -d . -f 1)
    echo "from .$filename_wo_ext import *" >> "$ROOT_DIR/$OUTPUT_DIR"/__init__.py

    docker run -v "$ROOT_DIR":/airbyte airbyte/code-generator:dev \
      --input "/airbyte/$INPUT_DIR/$filename_wo_ext.yaml" \
      --output "/airbyte/$OUTPUT_DIR/$filename_wo_ext.py" \
      --disable-timestamp
  done
}

main "$@"
